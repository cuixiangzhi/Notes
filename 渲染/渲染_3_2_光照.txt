物理知识
    电子
        基本粒子,带负电,电子运动形成电流,电场和磁场能控制电子的运动
        亚原子粒子,即比原子更小的粒子
        电子脱离原子核束缚在原子之间自由运动产生电流
        静电是指原子带电不均衡
    原子
        基本粒子,由一个带正电的原子核和若干绕核运动的电子构成
        原子核是由中子和质子组成的,中子不带电,质子带正电
        原子是构成物质的基本单位
    量子
        物理量的基本单位,微观下的离散量,比如光是由光子组成的,光子就是光的量子
        粒子具有波动性和粒子性,波会发生反射、折射、衍射
    波长
        一个震荡周期内波的传播距离,波分为引力波、电磁波等等
        电磁振荡:自感线圈 电容 电源
        电源对电容充电,然后电容放电不断正向反向直到电能损失到一定程度,继续电源充电
        电容电流方向反复变化在线圈内产生变化磁场,变化的电场和磁场产生电磁波
    能量守恒:
        入射光能量=漫反射能量+镜面反射能量+吸收能量+折射能量
光学知识
    光谱
        复色光经过分光后,被分开的单色光按照波长大小依次排列
        从大到小排列为长波无线电,无线电AMFM,微波,红外线,可见光,紫外线,X光,伽马射线
        原子稳定,电子跃迁(电子在原子内轨道上运动,吸收能量发生跃迁,分子结构被破坏),吸收能量,紫外能量高被臭氧层吸收
        光谱函数用于计算光在各个波长的能量分布
    光源
        能发出一定范围的电磁波的物体
    光学平面散射
        反射
            反射光线与入射光线、法线在同一平面,入射角等于反射角
        折射
            光从一种透明介质射入另一种透明介质,传播方向一般会发生变化
    非光学平面散射:
        现实中表面一般都是凹凸不平的,平面上每个点都是由很多朝向各异的微小光学平面组成的
        一部分发生反射,反射到不同的方向
        一部分发生折射,折射进入物质内部
        对于金属
            折射进入物质内部的光线被自由电子吸收,不再可见
        对于非金属等半透明物质
            1.物质一般是由很多折射率不同的微粒组成,光线遇到这些微粒发生反射折射,在物质内部传播后散射到不同方向
            其中一部分会再次穿过表面被观察到,这种现象称为次表面散射
            2.如果光线在物质内部传播距离小于观察尺度,也就是入射点、反射点、次表面出射点看起来是同一个点
            反射部分就是我们常说的高光,次表面散射部分是漫反射光,光线被散射到各个方向
            3.如果传播距离大于观察尺度,就需要使用次表面散射算法建模,散射部分与漫反射是不同的
        对于透明物质
            光线穿透透明物质,在另一侧再次发生反射折射,这种现象可以用BTDF模拟
几何知识:
    球坐标系
        球坐标r,0,φ转换为世界坐标为x=rsin0cosφ y=rsin0sinφ z=rcos0,0称为天顶角,φ称为方位角
    平面角
        圆上的一段圆弧,大小为s=r*0,整个圆的平面角为2π
    立体角
        单位是立体弧度,用sr表示,大小为半径为1的球体被以球心为顶点的椎体截得的表面积
        公式为w=s/r^2,也就是面积与半径平方之比
    微分立体角
        已知球坐标系下一个点(r,0,φ),当0增加d0,φ增加dφ时
        面积增加ds=(r*d0)*(rsin0*dφ)=r^2*sin0*d0dφ
        也就是微分立体角为dw=ds/r^2=sin0*d0dφ
        对0和φ做积分可以得出球体的表面积s=4πr^2
    微表面
        一个点由很多微表面组成
辐射度学
    辐射通量(光通量):
        每个光子都有一定的能量,频率越高,能量越高,单位是焦耳
        单位时间内通过表面或者空间区域的能量,单位是瓦特(W=J/s),用φ表示
    辐射强度(光强度):
        通过单位立体角的辐射通量,瓦特/球面度,I=dφ/dw
        一般用来衡量光源发出的光通量
    辐射照度(光照度):Irradiance
        通过单位面积的辐射通量,瓦特/单位面元,E=dφ/dA
        一般用来衡量进入表面的光通量
    辐射亮度(光亮度):Radiance
        通过单位面积单位立体角的辐射通量,瓦特/(平方米*球面度),L=dφ/dwdA'
        dA'是指微表面面积dA在入射方向的投影面积 dA'=dAcos0
        一般用来衡量离开表面的光通量
    法线分布
        对于观察方向V,只有入射方向和观察方向的半角向量H与法线N相同时,反射光才能被观察到
        D(h)法线分布函数用来描述物体表面一点半角向量朝向是H的微表面的比例
    遮挡比例
        微表面的入射光线被遮挡称为Shadowing,微表面的反射光线被遮挡称为Masking
        G(l,v)函数描述某个入射方向未被遮挡反射到指定V方向的比例
    反射比例
        光学平面并不会把所有光学都反射掉,反射比例符合菲涅尔方程
        F(l,h)函数用来表示光线被反射的比例
光照分类
    局部光照
        只考虑光源的直接照射
    全局光照
        除了光源的直接照射,还加入对光源多次反射的计算,也就是直接光+间接光
    环境光
        在局部光照模型中用来模拟所有的间接光,是一个常量 UNITY_LIGHTMODEL_AMBIENT
    自发光
        物体本身在给定方向上辐射多少能量,它不会照亮其他物体,只是本身会变亮
        局部光照中自发光只是物体本身发光,不会照亮周围的物体
    漫反射
        光线照射到物体表面,在各个方向反射多少能量,反射能量大小和入射角度有关,和观察角度无关
    高光
        光线照射到物体表面,镜面反射出的能量,反射能量与反射方向和观察角度有关
	光源类型
		平行光 点光源 聚光灯 面光源 反射探针 光照探针
光照方程
    经验模型
        Phong
            I = 环境光 + 漫反射光 + 高光
            I = KaIa + KdId*dot(n,l) + KsIs*pow(max(0,dot(r,v)),α)
            K是反射系数,I是光照强度,n是法线方向,l是入射方向,v是视线方向,r是反射方向 α是表面粗糙度,α越小越粗糙
        BlinnPhone
            Phone模型在反射方向和观察方向夹角超过90度,也就是观察方向趋向平行表面时,Phong会发生突变,BlinnPhong更接近真实情况
            pow(dot(n,h),α),h是l和v的半角向量,v在趋向于平行表面过程中h与n的夹角始终在90度之内,也就是边缘有一个渐变过程
    物理模型
	    BRDF:
            https://zhuanlan.zhihu.com/p/21376124
            https://chengkehan.github.io/PunctualLightSource.html
            https://www.cnblogs.com/luxishi/p/6409716.html
            http://www.voidcn.com/article/p-uamrlclq-brb.html
        	通用公式
        		Lo(r)=Le(r)+半球积分*F(l,v)*Li(l)*cos0*dw
        	单一光源
        		单一光源只会有一条入射光线,公式可以简化为 
        			Lo(r)=Le(r)+F(l,r)Li(l)cos0
        		一般会把该简化公式分解为漫反射和高光两部分
        			Lo(r)=Le(r)+kdFd+ksFs(l,r)Li(l)cos0
        CookTorranceBRDF
        	D公式 
        		微平面法线分布函数 Trowbridge-Reitz GGX
	        		D=m^2/[π*[dot(n,h)^2*(m^2-1)+1]^2]
        			m是表面粗糙度roughness
        	F公式 
        		菲涅尔反射公式
	        		F=f0+(1-f0)(1-n*v)^5 
	        		F0是垂直表面时的基础高光反射率
	        		非金属F0值一般在0.17以下,而且RGB分量一致,金属一般在0.5-1.0之间,RGB分量不一致
	        		F0=mix(F0,albedo,metalness)
        	G公式 
        		几何衰减函数
	        		SchilckGGX
		        		G=dot(n,v)/[dot(n,v)(1-k)+k] k=(m+1)^2/8
        				m是表面粗糙度roughness
	        		Smith考虑观察方向和入射方向
	        			G = G(n,v,k)G(n,l,k)
            积分公式
                Lo(r)=环境光La(r)+自发光Le(r)+半球积分*{ [漫反射kd*albedo/π+高光ksDFG/4dot(n,v)dot(n,l)] * Li(l)dot(n,l)dw
            简化公式
                一般用lightColor来代替辐射率L,入射辐射率为Li=lightColor*attenuation
                foreach light in lights do
                    Lo += [kd*albedo/π + ks*DFG/4dot(n,v)dot(n,l)] * Li * dot(n,l)
                end
                再加上环境光 c = Lo + albedo*ao
            UNITY公式
                漫反射(Disney)
                    albedo/π * (1 + (Fd-1)(1-dot(n,l))^5 * (1 + (Fd-1)(1-dot(n,v))^5))
                高光反射
                    GGX模型和BlinPhong模型
        UnityPBR工作流
            工作流区别
                不同的工作流参数不同,但是可以实现相同的效果
            金属工作流
                输入结构体->顶点着色器->输出结构体->片元着色器->
                UnityStandardInput.VertexInput->UnityStandardCore.vertForwardBase->UnityStandardCore.VertexOutputForwardBase->UnityStandardCore.fragForwardBase
                vert:计算VertexOutputForwardBase各个变量值
                frag:
                    1.使用MetallicSetup设置BRDF输入结构体FragmentCommonData
                    2.计算主光、阴影、遮挡、全局光照
                    3.调用UNITY_BRDF_PBS计算基于物理的渲染结果
                    4.调用UNITY_BRDF_GI添加全局光照的渲染结果
                    5.添加自发光效果
                    6.添加雾效模拟
                Albedo
                    视觉上认为的物体颜色,非金属一般在50-243之间,金属一般在186-255之间
                Metallic
                    金属度,数值范围从0到1,越大越像金属,R通道存储金属度
                Smoothness
                    光滑度,数值范围从0到1,越大越光滑,A通道存储光滑度
            高光反射工作流
                Albedo代表漫反射强度,对于金属仍然表示视觉上认为的物体颜色,对于金属非常接近黑色
                Specular选项代替金属度,对于非金属一般在0-55之间,对于金属一般用视觉上认为的颜色
渲染路径
	Vertex
		支持8个点光源,按照亮度排序,位置颜色信息存储在指定数组内
		MESH->VS(光照计算)->FS->FRAME_BUFFER
	Forward
		根据配置的逐像素光源个数,提取最亮的几个光源计算光照,其余的光源都以球谐函数
		MESH->VS->FS(光照计算)->FRAME_BUFFER
		ForwardBase: 
			#pragma multi_compile_fwdbase
			计算自发光、环境光、主平行光、逐顶点光、SH光、光照贴图、阴影
			Unity中设置为NotImporant的光会被按照逐顶点或者SH处理
			逐顶点光照计算 Shade4PointLights(...) unity_4LightPosXYZColorAtten
			球谐光照计算 
		ForwardAdd:  
			Blend One One 
			#pragma multi_compile_fwdadd
			计算额外的逐像素光源,AddPASS会根据照亮该物体的光源数量被执行多次
			照亮每个物体的逐像素光源个数有限制,Unity会根据光源的类型及对物体的影响程度(距离、强度、类型等)进行排序
			_LightColor0和_WorldSpaceLightPos0存储当前逐像素光源的颜色和位置
		光源信息
			Unity会根据当前光源类型为PASS的执行设置对应的光源属性 位置、颜色、衰减纹理、变换矩阵
			获取光的方向 
				UnityWorldSpaceLightDir(i.worldPos)
			获取光的颜色 
				_LightColor0
			获取光的衰减 
				平行光为 atten=1
				其它类型 
						lightSpacePos=mul(_LightMatrix0,i.worldPos).xyz	
						attenUV=dot(lightSpacePos,lightSpacePos).xx
						atten=tex2D(_LightTexture0,attenUV).UNITY_ATTEN_CHANNEL;
				直接获取 
						UNITY_LIGHT_ATTENUATION(atten,i,i.worldPos)
	Deferred
		第一次渲染
			不计算光照信息,只进行深度测试,光照相关数据写入G-BUFFER(坐标、法线、UV、反射系数等等)
		第二次渲染
			遍历屏幕像素,针对有效的像素点读取G-BUFFER数据进行光照计算,更新颜色缓冲区
			Unity默认使用Standard光照模型来计算,Internal-DeferrredShading.shader
		计算流程
			MESH->VS->FS(无光)->MRT(深度、法线、颜色三个BUFFER存储光照所需信息)->FRAME_BUFFER
		GBuffer信息
			RT0,存储漫反射颜色,A通道未使用
			RT1,存储高光反射颜色,A通道存储高光指数
			RT2,存储法线方向,A通道未使用
			RT3,存储自发光+光照贴图+反射探针
	ShadowCaster
		渲染阴影映射纹理时调用该shader,没有会调用Fallback的对应shader,否则不产生阴影
光照贴图
光线跟踪